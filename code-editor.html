<!DOCTYPE html>
<meta charset=utf-8>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>Raw-Roomintro Preview tool</title>
<style>
#html-input, #html-output {
	display: block;
}
#html-input {
	left: 0;
	right: auto;
	width: 500px;
}
#html-output {
	width: auto;
	right: 0;
	left: 501px;
}
#html-editor {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
}
</style>
<div id="header" class="header">
	<h1></h1>
</div>
<div id="html-input">
	<div id="html-editor">No dude en modificar el c√≥digo.</div>
</div>
<div id="html-output">
	<div>
		<div class="inner">
			<div class="infobox infobox-limited" id="html-caja-output"></div></div>
			<code><span id="html-intro-code"></span></code>
		</div>

	</div>
</div>
<script src="https://cdn.jsdelivr.net/ace/1.2.6/min/ace.js"></script>
<script src="https://play.pokemonshowdown.com/js/lib/jquery-2.1.4.min.js"></script>
<script src="https://play.pokemonshowdown.com/js/lib/html-css-sanitizer-minified.js"></script>
<script src="https://play.pokemonshowdown.com/js/battledata.js"></script>
<script>
function parseCSS(code) {
	var parsed = document.createElement('div')
	parsed.innerHTML = code
	var implDocument = document.implementation.createHTMLDocument("Temporary CSS storage")
	var stylesheets = parsed.getElementsByTagName('style')
	for (var i = 0; i < stylesheets.length; i++) {
		var element = stylesheets[i]
		// CSS element needs to be in document to be actually parsed
		implDocument.body.appendChild(element)
		var rules = element.sheet.cssRules
		for (var j = 0; j < rules.length; j++) {
			var rule = rules[j]
			var elements = parsed.querySelectorAll(rule.selectorText)
			for (var k = 0; k < elements.length; k++) {
				var element = elements[k]
				var newValue = (element.getAttribute('style') || "") + rule.style.cssText
				element.setAttribute('style', newValue)
			}
		}
	}
	return parsed.innerHTML
}
function modifyRoomIntro(action, editor) {
	var rawValue = editor.getSession().getValue()
	localStorage.setItem('code', rawValue)
	var value = parseCSS(rawValue)
	document.getElementById('html-caja-output').innerHTML = Tools.sanitizeHTML(value)
	var sanitizer = document.createElement('div')
	sanitizer.innerHTML = value
	document.getElementById('html-intro-code').textContent = sanitizer.innerHTML
}
var editor = ace.edit('html-editor')
var session = editor.getSession()
var Range = ace.require('ace/range').Range
session.setOption("useWorker", false)
session.setMode('ace/mode/html')
session.setUseWrapMode(true)
editor.on('change', modifyRoomIntro)
editor.selection.setRange(new Range(0, 0, true))
var code = localStorage.getItem('code')
if (code) {
	editor.getSession().setValue(code)
}
editor.focus()
modifyRoomIntro(null, editor)
</script>